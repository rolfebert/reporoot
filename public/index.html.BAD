<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buttons Database</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; }
    .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .auth-section { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
    input, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; font-size: 14px; }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
    .item-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 15px; }
    .item-card h3 { margin: 0 0 10px 0; font-size: 16px; }
    .button-details { font-size: 13px; line-height: 1.4; }
    .button-details div { margin: 4px 0; }
    .item-images { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
    .item-images img { border-radius: 4px; cursor: pointer; border: 1px solid #ddd; }
    @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } .item-card { padding: 12px; } }
    .item-images { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    .item-images img { width: calc(50% - 5px); height: 200px; object-fit: cover; border-radius: 4px; cursor: pointer; }
    .item-images img:only-child { width: 100%; }
    .create-form { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .form-grid > div { display: flex; flex-direction: column; }
    .form-grid label { font-size: 12px; font-weight: 600; color: #555; margin-bottom: 3px; }
    .form-grid input, .form-grid textarea { width: 100%; padding: 8px; font-size: 14px; box-sizing: border-box; }
    .form-full { grid-column: 1 / -1; }
    .create-form textarea { width: 100%; min-height: 80px; resize: vertical; }
    .hidden { display: none !important; }
    .error { color: #dc3545; margin-top: 10px; padding: 10px; background: #f8d7da; border-radius: 4px; }
    .success { color: #28a745; margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 4px; }
    .delete-btn { background: #dc3545; }
    .delete-btn:hover { background: #c82333; }
    .button-details { margin-top: 10px; font-size: 13px; color: #666; }
    .button-details div { margin: 3px 0; }
    .button-details strong { color: #333; }
    .analyzing { color: #007bff; font-weight: bold; margin-top: 10px; padding: 10px; background: #cfe2ff; border-radius: 4px; display: flex; align-items: center; gap: 10px; }
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .image-preview { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .image-preview-item { position: relative; width: 120px; height: 120px; }
    .image-preview-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; border: 2px solid #ddd; }
    .image-preview-item .remove { position: absolute; top: 5px; right: 5px; background: rgba(220, 53, 69, 0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 16px; line-height: 20px; }
    .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .loading-box { background: white; padding: 30px; border-radius: 8px; text-align: center; }
    .loading-box .spinner { margin: 0 auto 15px; width: 40px; height: 40px; border-width: 4px; }
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-box">
      <div class="spinner"></div>
      <p id="loadingText">Processing...</p>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <h1>üé® Buttons Database</h1>
      <div id="authSection" class="auth-section">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button type="button" onclick="togglePwd()">üëÅÔ∏è</button>
        <input type="password" id="confirmPassword" placeholder="Confirm Password" class="hidden">
        <button onclick="doLogin()">Login</button>
        <button id="regBtn" onclick="showReg()">Register</button>
      </div>
      <div id="loggedInSection" class="hidden">
        <p>Logged in as: <span id="userEmail"></span></p>
        <button onclick="doLogout()">Logout</button>
        <button onclick="clearUploadsFolder()" style="background: #dc3545; margin-left: 10px;">üóëÔ∏è Clear Uploads</button>
        <button onclick="toggleSearch()" style="background: #17a2b8; margin-left: 10px;">üîç Search</button>
      </div>
      <div id="message"></div>
    </div>

    <div id="createSection" class="create-form hidden">
      <h2>Add New Button</h2>
      <div style="margin-bottom: 15px;">
        <input type="file" id="imageFiles" accept="image/*" multiple onchange="handleImageSelect()">
        <p style="font-size: 12px; color: #666; margin-top: 5px;">üì∏ Upload front and back images (or multiple views)</p>
        <div id="imagePreview" class="image-preview"></div>
        <div id="analyzingMsg" class="analyzing hidden">
          <div class="spinner"></div>
          <span id="analyzeText">Analyzing images with AI...</span>
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-full">
          <label>Button Name/Title *</label>
          <input type="text" id="title" placeholder="Button Name/Title *">
        </div>
        <div>
          <label>Material</label>
          <input type="text" id="material" placeholder="Material">
        </div>
        <div>
          <label>Color</label>
          <input type="text" id="color" placeholder="Color">
        </div>
        <div>
          <label>Size</label>
          <input type="text" id="size" placeholder="Size">
        </div>
        <div>
          <label>Diameter</label>
          <input type="text" id="diameter" placeholder="Diameter">
        </div>
        <div>
          <label>Holes</label>
          <input type="number" id="holes" placeholder="Holes" min="0">
        </div>
        <div>
          <label>Style</label>
          <input type="text" id="style" placeholder="Style">
        </div>
        <div>
          <label>NBS Code</label>
          <input type="text" id="nbsCode" placeholder="NBS Code">
        </div>
        <div>
          <label>Division (I, III, IX)</label>
          <input type="text" id="division" placeholder="Division">
        </div>
        <div>
          <label>Section (1-27)</label>
          <input type="number" id="section" placeholder="Section" min="1" max="27">
        </div>
        <div>
          <label>Section Name</label>
          <input type="text" id="sectionName" placeholder="Section Name">
        </div>
        <div>
          <label>Age/Period</label>
          <input type="text" id="age" placeholder="Age/Period">
        </div>
        <div>
          <label>Back Type</label>
          <input type="text" id="backType" placeholder="Back Type">
        </div>
        <div>
          <label>Pictorial Subject</label>
          <input type="text" id="pictorialSubject" placeholder="Pictorial Subject">
        </div>
        <div>
          <label>Pattern</label>
          <input type="text" id="pattern" placeholder="Pattern">
        </div>
        <div>
          <label>Usage Type</label>
          <input type="text" id="usageType" placeholder="Usage Type">
        </div>
        <div>
          <label>Condition</label>
          <input type="text" id="buttonCondition" placeholder="Condition">
        </div>
        <div>
          <label>Manufacturer</label>
          <input type="text" id="manufacturer" placeholder="Manufacturer">
        </div>
        <div class="form-full">
          <label>Description</label>
          <textarea id="content" placeholder="Description"></textarea>
        </div>
        <div class="form-full">
          <label>Notes</label>
          <textarea id="notes" placeholder="Notes"></textarea>
        </div>
      </div>
      <button id="createBtn" onclick="createItem()" style="margin-top: 10px;">Create Button Entry</button>
    </div>

    <div id="searchSection" class="create-form hidden" style="margin-top: 20px;">
      <h2>üîç Search Buttons</h2>
      <div class="form-grid" style="margin-bottom: 10px;">
        <div>
          <label>Title/Name</label>
          <input type="text" id="searchTitle" placeholder="Button name">
        </div>
        <div>
          <label>Material</label>
          <input type="text" id="searchMaterial" placeholder="Material">
        </div>
        <div>
          <label>Color</label>
          <input type="text" id="searchColor" placeholder="Color">
        </div>
        <div>
          <label>Style</label>
          <input type="text" id="searchStyle" placeholder="Style">
        </div>
        <div>
          <label>NBS Code</label>
          <input type="text" id="searchNbsCode" placeholder="NBS Code">
        </div>
        <div>
          <label>Division</label>
          <select id="searchDivision">
            <option value="">Any</option>
            <option value="I">I (Old, pre-1918)</option>
            <option value="III">III (Modern, post-1918)</option>
            <option value="IX">IX (Age uncertain)</option>
          </select>
        </div>
        <div>
          <label>Section</label>
          <input type="number" id="searchSection" placeholder="Section (1-27)" min="1" max="27">
        </div>
        <div>
          <label>Back Type</label>
          <input type="text" id="searchBackType" placeholder="Back Type">
        </div>
      </div>
      <div style="display: flex; gap: 10px;">
        <button onclick="searchButtons()" style="background: #28a745;">üîç Search</button>
        <button onclick="clearSearch()" style="background: #6c757d;">Clear Filters</button>
      </div>
      <div id="searchResults" style="margin-top: 15px; font-size: 14px; color: #666;"></div>
    </div>

    <div id="itemsSection" class="items-grid"></div>
  </div>

  <script>
    const API_URL = 'http://localhost:4000';
    let token = localStorage.getItem('token');
    let userEmail = localStorage.getItem('userEmail');
    let uploadedImageIds = []; // Changed: store IDs instead of image objects
    let buttonsData = []; // For batch mode

    // Ensure analyzing message is hidden on page load
    document.addEventListener('DOMContentLoaded', function() {
      const analyzingMsg = document.getElementById('analyzingMsg');
      if (analyzingMsg) analyzingMsg.classList.add('hidden');
    });

    if (token) showLoggedIn();

    function showLoading(text) {
      document.getElementById('loadingText').textContent = text || 'Processing...';
      document.getElementById('loadingOverlay').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }

    function showReg() {
      document.getElementById('confirmPassword').classList.remove('hidden');
      document.getElementById('regBtn').textContent = 'Create Account';
      document.getElementById('regBtn').onclick = doRegister;
    }

    function togglePwd() {
      const pwd = document.getElementById('password');
      const confirm = document.getElementById('confirmPassword');
      const newType = pwd.type === 'password' ? 'text' : 'password';
      pwd.type = newType;
      if (confirm) confirm.type = newType;
    }

    async function doRegister() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const username = email.split('@')[0];

      if (!email || !password) return showMsg('Email and password required', 'error');
      if (password !== confirmPassword) return showMsg('Passwords do not match', 'error');

      showLoading('Creating account...');
      try {
        const res = await fetch(API_URL + '/api/v1/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password })
        });
        const data = await res.json();
        hideLoading();
        
        if (res.ok) {
          token = data.data.accessToken;
          userEmail = email;
          localStorage.setItem('token', token);
          localStorage.setItem('userEmail', userEmail);
          showMsg('Registration successful!', 'success');
          document.getElementById('confirmPassword').classList.add('hidden');
          showLoggedIn();
        } else {
          showMsg(data.error?.message || 'Registration failed', 'error');
        }
      } catch (err) {
        hideLoading();
        showMsg('Network error: ' + err.message, 'error');
      }
    }

    async function doLogin() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      if (!email || !password) return showMsg('Email and password required', 'error');

      showLoading('Logging in...');
      try {
        const res = await fetch(API_URL + '/api/v1/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        hideLoading();
        
        if (res.ok) {
          token = data.data.accessToken;
          userEmail = email;
          localStorage.setItem('token', token);
          localStorage.setItem('userEmail', userEmail);
          showMsg('Login successful!', 'success');
          showLoggedIn();
        } else {
          showMsg(data.error?.message || 'Login failed', 'error');
        }
      } catch (err) {
        hideLoading();
        showMsg('Network error: ' + err.message, 'error');
      }
    }

    function doLogout() {
      token = null;
      userEmail = null;
      uploadedImageIds = [];
      localStorage.removeItem('token');
      localStorage.removeItem('userEmail');
      document.getElementById('authSection').classList.remove('hidden');
      document.getElementById('loggedInSection').classList.add('hidden');
      document.getElementById('createSection').classList.add('hidden');
      document.getElementById('confirmPassword').classList.add('hidden');
      document.getElementById('itemsSection').innerHTML = '';
      document.getElementById('regBtn').textContent = 'Register';
      document.getElementById('regBtn').onclick = showReg;
      showMsg('Logged out', 'success');
    }

    function handleTokenExpiration() {
      showMsg('Session expired. Please log in again.', 'error');
      doLogout();
    }

    function showLoggedIn() {
      document.getElementById('authSection').classList.add('hidden');
      document.getElementById('loggedInSection').classList.remove('hidden');
      document.getElementById('createSection').classList.remove('hidden');
      document.getElementById('userEmail').textContent = userEmail;
      document.getElementById('analyzingMsg').classList.add('hidden');
      loadItems();
    }

    async function handleImageSelect() {
      const fileInput = document.getElementById('imageFiles');
      const files = Array.from(fileInput.files);
      
      if (files.length === 0) {
        document.getElementById('analyzingMsg').classList.add('hidden');
        buttonsData = [];
        return;
      }

      const analyzingMsg = document.getElementById('analyzingMsg');
      const analyzeText = document.getElementById('analyzeText');
      
      analyzeText.textContent = `Uploading ${files.length} image(s)...`;
      analyzingMsg.classList.remove('hidden');

      try {
        const formData = new FormData();
        files.forEach(file => formData.append('images', file));

        analyzeText.textContent = `Analyzing ${files.length} image(s) with AI...`;
        
        const res = await fetch(API_URL + '/api/v1/upload', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token },
          body: formData
        });

        if (res.status === 401) {
          handleTokenExpiration();
          analyzingMsg.classList.add('hidden');
          return;
        }

        if (res.ok) {
  const data = await res.json();
  console.log('Upload response:', data); // DEBUG
  
  // CRITICAL: Get image IDs from upload response
  if (data.data && data.data.imageIds) {
    uploadedImageIds = data.data.imageIds;
    
    // Display preview using database image IDs
    const previewDiv = document.getElementById('imagePreview');
    previewDiv.innerHTML = uploadedImageIds.map((imgId, idx) => `
      <div class="image-preview-item">
        <img src="${API_URL}/api/v1/images/${imgId}" alt="Preview ${idx + 1}">
        <button class="remove" onclick="removeImage(${idx})" title="Remove">√ó</button>
      </div>
    `).join('');
    
    // Auto-populate form if AI analysis data exists
    if (data.data.analysisData) {
      const info = data.data.analysisData;
      
      let titleParts = [];
      if (info.age && !info.age.includes('Modern')) titleParts.push(info.age);
      if (info.material) titleParts.push(info.material);
      if (info.color) titleParts.push(info.color);
      if (info.pictorialSubject) titleParts.push(info.pictorialSubject);
      if (info.style) titleParts.push(info.style);
      let titleValue = titleParts.join(' ') || 'Button';
      document.getElementById('title').value = titleValue;

      if (info.material) document.getElementById('material').value = info.material;
      if (info.size) document.getElementById('size').value = info.size;
      if (info.diameter) document.getElementById('diameter').value = info.diameter;
      if (info.color) document.getElementById('color').value = info.color;
      if (info.holes != null) document.getElementById('holes').value = info.holes;
      if (info.style) document.getElementById('style').value = info.style;
      if (info.nbsCode) document.getElementById('nbsCode').value = info.nbsCode;
      if (info.division) document.getElementById('division').value = info.division;
      if (info.section != null) document.getElementById('section').value = info.section;
      if (info.sectionName) document.getElementById('sectionName').value = info.sectionName;
      if (info.age) document.getElementById('age').value = info.age;
      if (info.backType) document.getElementById('backType').value = info.backType;
      if (info.pictorialSubject) document.getElementById('pictorialSubject').value = info.pictorialSubject;
      if (info.pattern) document.getElementById('pattern').value = info.pattern;
      if (info.usageType) document.getElementById('usageType').value = info.usageType;
      if (info.buttonCondition) document.getElementById('buttonCondition').value = info.buttonCondition;
      if (info.manufacturer) document.getElementById('manufacturer').value = info.manufacturer;
      if (info.notes) document.getElementById('notes').value = info.notes;
    }
    
    analyzeText.textContent = `‚úì ${uploadedImageIds.length} image(s) uploaded!`;
    setTimeout(() => analyzingMsg.classList.add('hidden'), 3000);
    showMsg(`‚úì Images uploaded successfully!`, 'success');
  } else {
    throw new Error('Invalid response - no imageIds returned');
  }

  } else {
          const errorData = await res.json();
          console.error('Upload failed:', errorData);
          analyzingMsg.classList.add('hidden');
          fileInput.value = '';
          document.getElementById('imagePreview').innerHTML = '';
          uploadedImageIds = [];
          buttonsData = [];
          showMsg('Upload failed: ' + (errorData.error?.message || res.statusText), 'error');
        }
      } catch (err) {
        console.error('Upload error:', err);
        analyzingMsg.classList.add('hidden');
        fileInput.value = '';
        document.getElementById('imagePreview').innerHTML = '';
        uploadedImageIds = [];
        buttonsData = [];
        showMsg('Upload error: ' + err.message, 'error');
      }
    }

    function removeImage(index) {
      uploadedImageIds.splice(index, 1);
      const previewDiv = document.getElementById('imagePreview');
      previewDiv.innerHTML = uploadedImageIds.map((imgId, idx) => `
        <div class="image-preview-item">
          <img src="${API_URL}/api/v1/images/${imgId}" alt="Preview ${idx + 1}">
          <button class="remove" onclick="removeImage(${idx})" title="Remove">√ó</button>
        </div>
      `).join('');
    }

    async function createItem() {
      const title = document.getElementById('title').value;
      if (!title) return showMsg('Button name/title required', 'error');
      if (uploadedImageIds.length === 0) return showMsg('Please upload at least one image', 'error');

      const createBtn = document.getElementById('createBtn');
      createBtn.disabled = true;
      createBtn.textContent = 'Creating...';
      showLoading('Saving button entry...');

      try {
        // CRITICAL FIX: Send image IDs, not image objects
        const res = await fetch(API_URL + '/api/v1/items', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({
            title,
            content: document.getElementById('content').value,
            imageIds: uploadedImageIds, // Send the IDs
            material: document.getElementById('material').value,
            size: document.getElementById('size').value,
            diameter: document.getElementById('diameter').value,
            color: document.getElementById('color').value,
            holes: document.getElementById('holes').value ? parseInt(document.getElementById('holes').value) : null,
            style: document.getElementById('style').value,
            nbsCode: document.getElementById('nbsCode').value,
            division: document.getElementById('division').value,
            section: document.getElementById('section').value ? parseInt(document.getElementById('section').value) : null,
            sectionName: document.getElementById('sectionName').value,
            age: document.getElementById('age').value,
            backType: document.getElementById('backType').value,
            pictorialSubject: document.getElementById('pictorialSubject').value,
            pattern: document.getElementById('pattern').value,
            usageType: document.getElementById('usageType').value,
            buttonCondition: document.getElementById('buttonCondition').value,
            manufacturer: document.getElementById('manufacturer').value,
            notes: document.getElementById('notes').value
          })
        });

        hideLoading();
        createBtn.disabled = false;
        createBtn.textContent = 'Create Button Entry';

        if (res.status === 401) {
          handleTokenExpiration();
          return;
        }

        if (res.ok) {
          showMsg('‚úì Button entry created successfully!', 'success');
          clearForm();
          loadItems();
        } else {
          const errorData = await res.json();
          showMsg('Failed to create: ' + (errorData.error?.message || res.statusText), 'error');
        }
      } catch (err) {
        hideLoading();
        createBtn.disabled = false;
        createBtn.textContent = 'Create Button Entry';
        showMsg('Network error: ' + err.message, 'error');
        console.error('Create error:', err);
      }
    }

    function clearForm() {
      ['title', 'content', 'material', 'size', 'diameter', 'color', 'holes', 'style', 'nbsCode', 'division', 'section', 'sectionName', 'age', 'backType', 'pictorialSubject', 'pattern', 'usageType', 'buttonCondition', 'manufacturer', 'notes'].forEach(id => {
        document.getElementById(id).value = '';
      });
      document.getElementById('imageFiles').value = '';
      document.getElementById('imagePreview').innerHTML = '';
      document.getElementById('analyzingMsg').classList.add('hidden');
      document.getElementById('createBtn').textContent = 'Create Button Entry';
      uploadedImageIds = [];
      buttonsData = [];
    }

    async function loadItems() {
      try {
        const res = await fetch(API_URL + '/api/v1/items', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        
        if (res.status === 401) {
          handleTokenExpiration();
          return;
        }
        
        const data = await res.json();
        
        if (res.ok) {
          const itemsHTML = data.data.map(item => {
            let imagesHTML = '';
            if (item.images && item.images.length > 0) {
              // CRITICAL FIX: Use image ID to load from database
              imagesHTML = '<div class="item-images">' + 
                item.images.map(img => `<img src="${API_URL}/api/v1/images/${img.id}" alt="${item.title}" onclick="window.open(this.src)" style="max-width: 120px; max-height: 120px; object-fit: cover;">`).join('') +
                '</div>';
            }
            
            let detailsHTML = '<div class="button-details">';
            if (item.material) detailsHTML += '<div><strong>Material:</strong> ' + item.material + '</div>';
            if (item.color) detailsHTML += '<div><strong>Color:</strong> ' + item.color + '</div>';
            if (item.size) detailsHTML += '<div><strong>Size:</strong> ' + item.size + '</div>';
            if (item.diameter) detailsHTML += '<div><strong>Diameter:</strong> ' + item.diameter + '</div>';
            if (item.holes != null) detailsHTML += '<div><strong>Holes:</strong> ' + item.holes + '</div>';
            if (item.style) detailsHTML += '<div><strong>Style:</strong> ' + item.style + '</div>';
            if (item.nbsCode) detailsHTML += '<div><strong>NBS:</strong> ' + item.nbsCode + '</div>';
            if (item.division) detailsHTML += '<div><strong>Division:</strong> ' + item.division + '</div>';
            if (item.section) detailsHTML += '<div><strong>Section:</strong> ' + item.section + ' (' + (item.sectionName || '') + ')</div>';
            if (item.age) detailsHTML += '<div><strong>Age:</strong> ' + item.age + '</div>';
            if (item.backType) detailsHTML += '<div><strong>Back:</strong> ' + item.backType + '</div>';
            if (item.pictorialSubject) detailsHTML += '<div><strong>Subject:</strong> ' + item.pictorialSubject + '</div>';
            if (item.pattern) detailsHTML += '<div><strong>Pattern:</strong> ' + item.pattern + '</div>';
            if (item.usageType) detailsHTML += '<div><strong>Usage:</strong> ' + item.usageType + '</div>';
            if (item.buttonCondition) detailsHTML += '<div><strong>Condition:</strong> ' + item.buttonCondition + '</div>';
            if (item.manufacturer) detailsHTML += '<div><strong>Mfg:</strong> ' + item.manufacturer + '</div>';
            if (item.notes) detailsHTML += '<div><strong>Notes:</strong> ' + item.notes + '</div>';
            detailsHTML += '</div>';
            
            return `
              <div class="item-card">
                ${imagesHTML}
                <h3>${item.title}</h3>
                <p>${item.content || ''}</p>
                ${detailsHTML}
                <button class="delete-btn" onclick="deleteItem(${item.id})" style="margin-top: 10px;">Delete</button>
              </div>
            `;
          }).join('');
          
          document.getElementById('itemsSection').innerHTML = itemsHTML || '<p>No buttons yet. Add one!</p>';
        }
      } catch (err) {
        showMsg('Failed to load items: ' + err.message, 'error');
      }
    }

    let allItemsCache = null;

    async function getAllItems() {
      if (allItemsCache) return allItemsCache;
      
      const res = await fetch(API_URL + '/api/v1/items